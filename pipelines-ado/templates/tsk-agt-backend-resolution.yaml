# bash: extract backend config from JSON and assure DNS resolution
parameters:
  - name: name
    type: string
  - name: displayName
    type: string
  - name: tfBackendConfigJSON
    type: string
    default: '{}'

steps:  
  - task: Bash@3
    name: ${{ parameters.name }}
    displayName: ${{ parameters.displayName }}
    inputs:
      targetType: inline
      script: |
        #!/bin/bash
        set -e
        
        BACKEND_JSON='${{ parameters.tfBackendConfigJSON }}'
        HOSTS_FILE="/etc/hosts"
        
        echo "INFO: ======= Extracting Backend Configuration ======="
        echo "INFO:     Raw backend JSON: $BACKEND_JSON"
        echo "INFO: ==============================================="
        
        # Extract FQDN and Private IP from JSON
        if command -v jq >/dev/null 2>&1; then
          echo "INFO: Using jq for JSON parsing..."
          BACKEND_FQDN=$(echo "$BACKEND_JSON" | jq -r '.fqdn // empty')
          EXPECTED_IP=$(echo "$BACKEND_JSON" | jq -r '.private_ip_address // empty')
          BACKEND_NAME=$(echo "$BACKEND_JSON" | jq -r '.name // empty')
          BACKEND_CONTAINER=$(echo "$BACKEND_JSON" | jq -r '.tf_backend_container // empty')
        else
          echo "INFO: jq not available, using grep/sed fallback..."
          BACKEND_FQDN=$(echo "$BACKEND_JSON" | grep -o '"fqdn":"[^"]*"' | sed 's/"fqdn":"\([^"]*\)"/\1/' || echo "")
          EXPECTED_IP=$(echo "$BACKEND_JSON" | grep -o '"private_ip_address":"[^"]*"' | sed 's/"private_ip_address":"\([^"]*\)"/\1/' || echo "")
          BACKEND_NAME=$(echo "$BACKEND_JSON" | grep -o '"name":"[^"]*"' | sed 's/"name":"\([^"]*\)"/\1/' || echo "")
          BACKEND_CONTAINER=$(echo "$BACKEND_JSON" | grep -o '"tf_backend_container":"[^"]*"' | sed 's/"tf_backend_container":"\([^"]*\)"/\1/' || echo "")
        fi
        
        echo "INFO: Extracted values:"
        echo "      FQDN:       $BACKEND_FQDN"
        echo "      Private IP: $EXPECTED_IP"
        echo "      Name:       $BACKEND_NAME"
        echo "      Container:  $BACKEND_CONTAINER"
        echo ""
        
        # Validate that we have the required values
        if [[ -z "$BACKEND_FQDN" ]]; then
          echo "Error: Could not extract FQDN from JSON"
          echo "       Please check that the JSON contains a 'fqdn' property"
          exit 1
        fi
        
        if [[ -z "$EXPECTED_IP" ]]; then
          echo "Error: Could not extract private IP from JSON"
          echo "       Please check that the JSON contains a 'private_ip_address' property"
          exit 1
        fi
        
        echo "INFO: ======= Backend DNS Resolution Check ======="
        echo "INFO:     FQDN: $BACKEND_FQDN"
        echo "INFO:     Expected IP: $EXPECTED_IP"
        echo "INFO: ============================================"
        
        # Function to resolve FQDN using methods that honour /etc/hosts
        resolve_fqdn() {
            local fqdn="$1"
            local resolved_ips=()
            
            echo "INFO: Resolving FQDN '$fqdn' (checking /etc/hosts and local resolution)..."
            
            # Method 3: ping test (honours /etc/hosts)
            if [[ ${#resolved_ips[@]} -eq 0 ]] && command -v ping >/dev/null 2>&1; then
                echo "INFO: Trying ping resolution test..."
                ping_output=$(ping -c 1 -W 2 "$fqdn" 2>/dev/null | head -1 || true)
                if [[ -n "$ping_output" ]]; then
                    # Extract IP from ping output: "PING hostname (IP) ..."
                    if [[ $ping_output =~ \(([0-9]+\.[0-9]+\.[0-9]+\.[0-9]+)\) ]]; then
                        ip="${BASH_REMATCH[1]}"
                        if [[ ! " ${resolved_ips[*]} " =~ " $ip " ]]; then
                            resolved_ips+=("$ip")
                        fi
                    fi
                fi
            fi
        }
        
        # Resolve the FQDN
        RESOLVED_IPS=$(resolve_fqdn "$BACKEND_FQDN")
        
        if [[ -z "$RESOLVED_IPS" ]]; then
            echo "Error: DNS resolution failed completely for '$BACKEND_FQDN'"
            NEEDS_HOSTS_ENTRY=true
        else
            echo "INFO: Resolved IPs: $RESOLVED_IPS"
            
            # Check if the expected IP is among the resolved IPs
            if [[ " $RESOLVED_IPS " =~ " $EXPECTED_IP " ]]; then
                echo "INFO: FQDN '$BACKEND_FQDN' correctly resolves to expected IP '$EXPECTED_IP'"
                NEEDS_HOSTS_ENTRY=false
            else
                echo "WARNING: FQDN '$BACKEND_FQDN' does not resolve to expected IP '$EXPECTED_IP'"
                echo "         Resolved to: $RESOLVED_IPS but expected: $EXPECTED_IP"
                 echo "        need to add local hosts entry"
                NEEDS_HOSTS_ENTRY=true
            fi
        fi
        
        if [[ "$NEEDS_HOSTS_ENTRY" == "true" ]]; then
            echo ""
            echo "INFO: ======= Creating Hosts File Entry ======="
            
            # Check if hosts file exists
            if [[ ! -f "$HOSTS_FILE" ]]; then
                echo "Error: Hosts file '$HOSTS_FILE' does not exist"
                exit 1
            fi
            
            ENTRY_TO_ADD="$EXPECTED_IP\t$BACKEND_FQDN"
            
            # Check if entry already exists with the correct IP
            if grep -q "^[[:space:]]*$EXPECTED_IP[[:space:]]\+$BACKEND_FQDN[[:space:]]*$" "$HOSTS_FILE"; then
                echo "INFO: Hosts entry already exists with correct IP"
            else
                echo "INFO: Adding hosts entry: $EXPECTED_IP  $BACKEND_FQDN"
                
                # Add the new entry
                echo -e "$EXPECTED_IP\t$BACKEND_FQDN" | sudo tee -a "$HOSTS_FILE" > /dev/null
                 
                echo "INFO: Added hosts entry: $EXPECTED_IP  $BACKEND_FQDN"
                
                # Verify the entry was added
                if grep -q "^[[:space:]]*$EXPECTED_IP[[:space:]]\+$BACKEND_FQDN[[:space:]]*$" "$HOSTS_FILE"; then
                    echo "INFO: Hosts entry verified successfully"
                else
                    echo "Error: Failed to verify hosts entry"
                    exit 1
                fi
            fi
        else
            echo ""
            echo "INFO: No hosts file modification needed"
        fi
        
        echo ""
        echo "INFO: ======= Final Verification ======="
        
        # Brief pause to allow any cache refresh
        sleep 2
        
        # Final verification - test resolution again
        FINAL_IPS=$(resolve_fqdn "$BACKEND_FQDN")
        
        if [[ -n "$FINAL_IPS" ]]; then
            echo "INFO: Final resolution test: $FINAL_IPS"
        else
            echo "Error: Final verification failed - could not resolve '$BACKEND_FQDN'"
        fi
        
        echo "INFO: =================================="