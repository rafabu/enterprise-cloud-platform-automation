# bash: extract backend config from JSON
parameters:
  - name: name
    type: string
  - name: displayName
    type: string
#   - name: tfBackendConfigJSON
#     type: string
#     default: '{}'
  - name: tfBackendConfigJSONL0
    type: string
    default: '{}'
  - name: tfBackendConfigJSONL1
    type: string
    default: '{}'
  - name: tfBackendConfigJSONL2
    type: string
    default: '{}'

steps:  
  - task: Bash@3
    name: ${{ parameters.name }}
    displayName: ${{ parameters.displayName }}
    inputs:
      targetType: inline
      script: |
        #!/bin/bash
        set -e

        # Array of levels to process
        LEVELS=("level0" "level1" "level2")
        
        for LEVEL in "${LEVELS[@]}"; do  
          # Select the appropriate backend JSON based on level
          case "$LEVEL" in
            "level0")
              BACKEND_JSON='${{ parameters.tfBackendConfigJSONL0 }}'
              ;;
            "level1")
              BACKEND_JSON='${{ parameters.tfBackendConfigJSONL1 }}'
              ;;
            "level2")
              BACKEND_JSON='${{ parameters.tfBackendConfigJSONL2 }}'
              ;;
            *)
              echo "ERROR: Unknown level: $LEVEL"
              continue
              ;;
          esac
          
          # Skip if JSON is empty or just '{}'
          if [[ -z "$BACKEND_JSON" ]] || [[ "$BACKEND_JSON" == "{}" ]]; then
            echo "INFO: No backend configuration for $LEVEL, skipping..."
            continue
          fi
        
          echo "INFO: ======= Extracting Backend Configuration ======="
          echo "INFO:     Level: $LEVEL"
          echo "INFO:     Raw backend JSON: $BACKEND_JSON"
          echo "INFO: ==============================================="
        
          # Extract FQDN and Private IP from JSON
          if command -v jq >/dev/null 2>&1; then
            echo "INFO: Using jq for JSON parsing..."
            BACKEND_FQDN=$(echo "$BACKEND_JSON" | jq -r '.fqdn // empty')
            EXPECTED_IP=$(echo "$BACKEND_JSON" | jq -r '.private_ip_address // empty')
            ECP_TG_BACKEND_NAME=$(echo "$BACKEND_JSON" | jq -r '.name // empty')
            ECP_TG_BACKEND_RESOURCE_GROUP_NAME=$(echo "$BACKEND_JSON" | jq -r '.resource_group_name // empty')
            ECP_TG_BACKEND_SUBSCRIPTION_ID=$(echo "$BACKEND_JSON" | jq -r '.subscription_id // empty')
            ECP_TG_BACKEND_CONTAINER=$(echo "$BACKEND_JSON" | jq -r '.tf_backend_container // empty')
          else
            echo "ERROR: jq not available..."
            exit 1
          fi
        
          LEVEL_UPPER=$(echo "$LEVEL" | tr '[:lower:]' '[:upper:]')
          echo "INFO: Extracted backend values for $LEVEL:"
          echo "      ECP_TG_BACKEND_${LEVEL_UPPER}_SUBSCRIPTION_ID:     $ECP_TG_BACKEND_SUBSCRIPTION_ID"
          echo "      ECP_TG_BACKEND_${LEVEL_UPPER}_RESOURCE_GROUP_NAME: $ECP_TG_BACKEND_RESOURCE_GROUP_NAME"
          echo "      ECP_TG_BACKEND_${LEVEL_UPPER}_NAME:                $ECP_TG_BACKEND_NAME"
          echo "      ECP_TG_BACKEND_${LEVEL_UPPER}_CONTAINER:           $ECP_TG_BACKEND_CONTAINER"
          echo ""

           # Set variables for use in subsequent pipeline steps
          echo "##vso[task.setvariable variable=ECP_TG_BACKEND_${LEVEL_UPPER}_SUBSCRIPTION_ID;isOutput=true]$ECP_TG_BACKEND_SUBSCRIPTION_ID"
          echo "##vso[task.setvariable variable=ECP_TG_BACKEND_${LEVEL_UPPER}_RESOURCE_GROUP_NAME;isOutput=true]$ECP_TG_BACKEND_RESOURCE_GROUP_NAME"
          echo "##vso[task.setvariable variable=ECP_TG_BACKEND_${LEVEL_UPPER}_NAME;isOutput=true]$ECP_TG_BACKEND_NAME"
          echo "##vso[task.setvariable variable=ECP_TG_BACKEND_${LEVEL_UPPER}_CONTAINER;isOutput=true]$ECP_TG_BACKEND_CONTAINER"
        done
        
        echo ""
        echo "INFO: ========================================================"
        echo "INFO: All levels processed"
        echo "INFO: ========================================================"
        