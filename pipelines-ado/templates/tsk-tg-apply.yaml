# terragrunt: plan (or plan destroy)
parameters:
  - name: name
    type: string
  - name: displayName
    type: string
  - name: serviceConnectionName
    type: string
  - name: workingDir
    type: string
  - name: queueExcludeDir
    default: 'no-exclude-defined'
    type: string
  - name: bootstrapWorkingDir
    type: string
    default: ''
  - name: tfDestroy
    type: boolean
    default: false

steps:
  - task: Bash@3
    name: prepare_terragrunt_folders
    displayName: prepare terragrunt tmp
    inputs:
      targetType: inline
      script: |
        set -e

        rm -rf "$(Agent.TempDirectory)/terragrunt"
        mkdir "$(Agent.TempDirectory)/terragrunt"
        mkdir "$(Agent.TempDirectory)/terragrunt/providers"

  - task: AzureCLI@2
    name: tfapplybootstrap
    displayName: terragrunt bootstrap
    condition: ne('${{ parameters.bootstrapWorkingDir }}', '')
    inputs:
      azureSubscription: ${{ parameters.serviceConnectionName }}
      addSpnToEnvironment: true
      visibleAzLogin: false
      scriptType: bash
      scriptLocation: inlineScript
      inlineScript: |
        echo "======= terragrunt info ======="
        echo "  $(terragrunt --version)"
        echo "  $(terragrunt info print)"
        echo "  TG_PROVIDER_CACHE_DIR: $TG_PROVIDER_CACHE_DIR"
        echo "======= terraform info ======="
        echo "  $(terragrunt run version)"
        echo "======= working directory ======="
        echo "  ${{ parameters.bootstrapWorkingDir }}"
        echo "========================= ======="
        echo ""

        export ARM_TENANT_ID="$tenantId"
        export ARM_CLIENT_ID="$servicePrincipalId"
        export ARM_OIDC_TOKEN="$idToken"
        export ARM_CLIENT_SECRET="$servicePrincipalKey"
        if [ -n "$idToken" ] && [ -z "$servicePrincipalKey" ]; then export ARM_USE_OIDC="true"; else export ARM_USE_OIDC="false"; fi
        
        echo "====== terraform applying ======="
        terragrunt run --all --working-dir "${{ parameters.bootstrapWorkingDir }}" --queue-exclude-external --non-interactive --provider-cache -- apply -parallelism=30

        rc=$?
        set -e
        if [[ $rc -eq 0 ]]; then
          echo "Terraform apply succeeded."
        else
          echo "Terraform apply failed with exit code: $rc"
          exit $rc
        fi

        echo "=========================================================="
        echo ""
    env:
      TG_PROVIDER_CACHE_DIR: $(Agent.TempDirectory)/terragrunt/providers
      TG_PROVIDER_CACHE: "1"

  - task: AzureCLI@2
    name: tfapply
    displayName: terragrunt apply
    inputs:
      azureSubscription: ${{ parameters.serviceConnectionName }}
      addSpnToEnvironment: true
      visibleAzLogin: false
      scriptType: bash
      scriptLocation: inlineScript
      inlineScript: |
        echo "======= terragrunt info ======="
        echo "  $(terragrunt --version)"
        echo "  $(terragrunt info print)"
        echo "  TG_PROVIDER_CACHE_DIR: $TG_PROVIDER_CACHE_DIR"
        echo "======= terraform info ======="
        echo "  $(terragrunt run version)"
        echo "======= working directory ======="
        echo "  ${{ parameters.workingDir }}"
        echo "========================= ======="
        echo ""

        export ARM_TENANT_ID="$tenantId"
        export ARM_CLIENT_ID="$servicePrincipalId"
        export ARM_OIDC_TOKEN="$idToken"
        export ARM_CLIENT_SECRET="$servicePrincipalKey"
        if [ -n "$idToken" ] && [ -z "$servicePrincipalKey" ]; then export ARM_USE_OIDC="true"; else export ARM_USE_OIDC="false"; fi

        if [ "${{ parameters.tfDestroy }}" = "True" ]; then
          echo "====== terraform DESTROY planning ======="
          terragrunt run --all --working-dir "${{ parameters.workingDir }}" --queue-exclude-external --queue-exclude-dir "${{ parameters.queueExcludeDir }}" --non-interactive --provider-cache -- apply -destroy -parallelism=30
        else
          echo "====== terraform planning ======="
          terragrunt run --all --working-dir "${{ parameters.workingDir }}" --queue-exclude-external --queue-exclude-dir "${{ parameters.queueExcludeDir }}" --non-interactive --provider-cache -- apply -parallelism=30
        fi

        rc=$?
        set -e
        if [[ $rc -eq 0 ]]; then
          echo "No errors, infrastructure updates successfully applied."
        else
          echo "Terraform apply failed."
          exit $rc
        fi
    env:
      TG_PROVIDER_CACHE_DIR: $(Agent.TempDirectory)/terragrunt/providers
      TG_PROVIDER_CACHE: "1"

